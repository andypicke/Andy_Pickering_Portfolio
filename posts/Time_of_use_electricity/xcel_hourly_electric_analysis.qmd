---
title: "How has time-of-use pricing affected our home electricity use?"
author: Andy Pickering
date: today
date-modified: today
format: 
  html:
    code-link: true
    code-fold: true
    code-tools: true
    toc: true
    fig-width: 9
    fig-height: 7
    tbl-cap-location: bottom
editor: visual
categories: [EV, R, visualization, energy]
draft: true
freeze: auto
---

# Introduction

In this blog post, I'll analyze our home electricity usage, using hourly data from our "[smart meter](https://coloradosun.com/2021/07/01/xcel-energy-smart-meters-time-of-use-billing/)". Our electricity provider ([Xcel](https://www.xcelenergy.com/)) currently bills us according to [Time-Of-Use (TOU) pricing](https://co.my.xcelenergy.com/s/billing-payment/residential-rates/time-of-use-pricing), where electricity costs more in the weekday afternoon-early evening period when demand tends to be higher.

I was interested in quantifying how much the TOU pricing has affected our electricity usage patterns. Qualitatively I know we have tried to modify our behavior to take advantage of the TOU rate structure in a couple ways:

-   We try to avoid using large appliances (dishwasher, oven, washer and dryer, etc.) during peak periods.

-   We currently have two electric vehicles; one full EV and one plug-in hybrid. We typically charge these at home on a level 1 (120V) charger. They both have charge timers that we have programmed to turn off during peak periods (3-7 pm weekdays).

In addition to seeing how the TOU pricing has affected our electricity usage patterns, I am curious about how it might be introducing an artificial spike in electricity demand if everyone turns on their appliances or starts charging their EVs right at 7pm when the peak pricing ends. This issue is discussed in a recent [blog post from EnergyHub](https://www.energyhub.com/blog/avoiding-gridlock-why-time-of-use-tou-rates-arent-the-long-term-solution-for-managing-local-ev-load){.uri}.

# Data

## Downloading data

Unfortunately Xcel does not have a public API or a way to request a date-range of data, so I had to download a hourly data file for each day individually. I downloaded data for a \~ 1 month period and combined the files into a single data frame in a separate script. Our current Xcel TOU rate categories are:

-   Weekdays 1-3pm: *mid-peak*

-   Weekdays 3-7pm: *peak*

-   All other times (and holidays): *off-peak*

@tbl-hourly-elec shows the data I working with. I've added columns for the hour, day of week, and an indicator for whether it is a weekday or weekend. Ideally I would have data from before TOU pricing was implemented to compare to, but this is not possible because TOU pricing began soon after we got our smart meter. I will instead compare weekdays and weekends, since there is no peak pricing on weekends.

```{r}
#| code-summary: Load libraries and read data

# read hourly electric usage data downloaded from myxcel account

suppressPackageStartupMessages(library(tidyverse))
ggplot2::theme_set(theme_grey(base_size = 16))
suppressPackageStartupMessages(library(here))
suppressPackageStartupMessages(library(DT))

df <- readRDS('data/hourly_elec_xcel_combined') |>
  select(-c(category)) |>
  mutate(rate_category = as.factor(rate_category)) |>
  mutate(rate_category = forcats::fct_relevel(rate_category, c("on_peak","mid_peak","off_peak"))) 
#  mutate(rate_category = forcats::fct_recode(On Peak = "on_peak", Mid Peak = "mid_peak", Off Peak = "off_peak" ))


```

```{r}
#| label: tbl-hourly-elec
#| tbl-cap: Hourly electricity usage data

df |>
  DT::datatable(options = list(pageLength = 5), rownames = FALSE)


```

# Analysis

<!-- ## Daily -->

<!-- @fig-daily-kwh-rate shows total daily electricity use, with the colors indicating the rate category. You can see that there is a fair bit of variability, and the majority of our electricity usage is during the off-peak periods. -->

```{r}
# #| label: fig-daily-kwh-rate
# #| fig-cap: Stacked bar chart of daily electricity usage [kWh], colored by rate category.
# 
# df_daily <- df |>
#   group_by(date, rate_category) |>
#   summarise(kwh = sum(kwh), .groups = 'drop')
# 
# 
# df_daily |>
#   ggplot(aes(date, kwh)) +
#   geom_col(aes(fill = rate_category),position = "stack") +
#   labs(x = "Date",
#        y = "kWh",
#        title = "Daily Electricity Use") +
#   theme(legend.title = element_blank())

```

@fig-kwh-all-ratecolor shows all hourly values, colored by the rate category. This figure shows that nearly all the larger values (greater than \~2 kWh) are during off-peak times. @fig-histogram-rate-category also demonstrates this pattern with boxplots; note the much longer tail for the off-peak period.

```{r}
#| label: fig-kwh-all-ratecolor
#| fig-cap: Hourly electricity usage [kWh] vs time, colored by rate category

df |>
  ggplot(aes(datetime, kwh)) +
  geom_point(size = 4, alpha = 0.4, aes(color = rate_category)) +
    labs( x = '',
        y = 'kWh',
        title = "Hourly Electriciy Usage") +
  theme(legend.title = element_blank())


```

```{r}
#| label: fig-histogram-rate-category
#| fig-cap: Histogram of all data
#| fig-width: 7
#| fig-height: 5
#| 

df |>
  ggplot(aes(x = kwh)) +
  geom_histogram(binwidth = 0.25) +
  geom_rug() +
  facet_grid(~rate_category) +
  labs(x = "kWh",
       y = '',
       title = "Histograms of hourly electric usage ")

```

```{r}
#| label: tbl-rate-comparisons
#| tbl-cap: Comparison of electricity use statistics for each rate category

df |> 
  group_by(rate_category) |>
  summarize(tot_kwh = sum(kwh),
            avg_kwh = round(mean(kwh),2),
            med_kwh = round(median(kwh),2),
            max_kwh = round(max(kwh),2)
            ) |>
  DT::datatable(options = list(pageLength = 5), rownames = FALSE)
            

```

```{r}

# df |> 
#   filter(is_weekend == 0) |>
#   group_by(rate_category) |>
#   summarize(tot_elec_per_rate = sum(kwh)) |>
#   mutate(total = sum(tot_elec_per_rate)) |>
#   mutate(pct = tot_elec_per_rate/total*100)


```

### Example electricity usage for a single day

@fig-usage-oneday shows hourly electricity usage for a single weekday. Note the sharp increase at 7pm, largely due to EV charging turning on. There is also a sharp decrease at 3pm (the beginning of peak pricing), where EV was charging and shut off on timer.

```{r}
#| label: fig-usage-oneday
#| fig-cap: Hourly electricity usage for a single weekday. 

the_date <- '2024-01-26'

df |>
  filter(date == the_date) |>
  ggplot(aes(hour, kwh)) +
  geom_col(aes(fill = rate_category)) +
  labs(x = "Hour of Day",
       y = "kWh",
       title = "Hourly Electricity Use For 1 Day",
       subtitle = lubridate::wday(the_date, label = TRUE, abbr = FALSE)) +
  theme(legend.title = element_blank()) +
    geom_vline(xintercept = c(13,15,19),linetype = 'dashed', color = 'black') 

```

### Boxplot of hourly usage, for weekend/weekday separate

```{r}
#| label: fig-boxplot-weekday-weekend
#| fig-cap: Boxplots of hourly electricity usage for weekdays and weekends. Red lines indicate peak hours (weekdays)

df |>
  ggplot(aes(hour,kwh, group = hour)) +
  geom_boxplot() +
  facet_grid(~is_weekend) +
  geom_vline(xintercept = c(15,19),linetype = 'dashed', color = 'red') +
  labs(y = 'kWh',
       x = 'Hour',
       title = 'Hourly electric usage',
       subtitle = "Weekday/Weekend")

```

@fig-avg-usage_weekday-weekend shows the average hourly electricity usage for weekdays and weekends. Dashed vertical lines indicate peak pricing hours (weekdays only).

```{r}
#| label: fig-avg-usage_weekday-weekend
#| fig-cap: Average hourly electricity usage for weekdays and weekends.Red lines indicate peak hours (weekdays)

g <- df |>
  mutate(wday_label = if_else(is_weekend == 0, 'Weekdays','Weekends')) |>
  group_by(hour, wday_label) |>
  summarize(usage = mean(kwh), .groups = 'drop') |>
  ggplot(aes(hour, usage, group = wday_label)) +
  geom_line(aes(color = wday_label), linewidth = 1.5) +
  geom_vline(xintercept = c(13,15,19),linetype = 'dashed', color = 'black') +
  theme(legend.title = element_blank()) +
  labs(y = 'kWh',
       x = 'Hour',
       title = 'Average Hourly electric usage',
       subtitle = "Weekday/Weekend")

plotly::ggplotly(g)
```

## Summary

-   Under TOU pricing, we have shifted our electricity usage and tend to use less during peak pricing.
-   On many days, this shift has created a new spike in demand at the end of peak pricing (7pm weekdays), as well as a sharp decrease in demand at the beginning of the peak pricing period.
-   This spike in demand could have negative consequences for the local energy infrastructure, as discussed in a recent [blog post from EnergyHub](https://www.energyhub.com/blog/avoiding-gridlock-why-time-of-use-tou-rates-arent-the-long-term-solution-for-managing-local-ev-load){.uri} .

### Questions and further analysis

# SessionInfo

To enhance reproduciblity, the R *sessionInfo* is included below.

```{r}

sessionInfo()

```
